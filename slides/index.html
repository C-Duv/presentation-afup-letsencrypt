<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<title>CSR, PKI puis Let's Encrypt</title>

		<meta name="description" content="Présentation de Let's Encrypt à l'AFUP Lyon">
		<meta name="author" content="DUVERGIER Claude">


		<link rel="stylesheet" href="css/reveal.css">
		<link rel="stylesheet" href="css/theme/black.css">
		<link rel="stylesheet" href="css/custom.css">

		<!-- Theme used for syntax highlighting of code -->
		<link rel="stylesheet" href="lib/css/zenburn.css">

		<!-- Printing and PDF exports -->
		<script>
			var link = document.createElement( 'link' );
			link.rel = 'stylesheet';
			link.type = 'text/css';
			link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
			document.getElementsByTagName( 'head' )[0].appendChild( link );
		</script>
	</head>
	<body>
		<div class="reveal">
			<div class="slides">
				<section>
					<h1><em>CSR</em>, <em>PKI</em> puis <em>Let's Encrypt</em></h1>

					<div class="fragment">
						<p>Histoire d'une migration de certificats classiques vers des certificats <em>Let's Encrypt</em><br />
						(+ une <em>PKI</em> maison au passage)</p>
					</div>

					<p>Lyon, le 15/02/2017</p>
				</section>

				<section data-background-image="./images/backgrounds/pexels-photo-30725.jpg" data-background-size="contain">
					<h2>Le parcours</h2>
					<ul>
						<li>(Présentations)</li>
						<li>(HTTPS et la confiance)</li>
						<li>Pourquoi ?</li>
						<li>Les <em>CA</em>s</li>
						<li>Une <em>PKI</em></li>
						<li><em>Let's Encrypt</em> !</li>
					</ul>
				</section>

				<section>
					<section class="section-title" data-background-image="./images/backgrounds/silhouettes-68483_1920.jpg" data-background-size="contain">
						<h2 style="margin-top: 2.5em;">Présentations</h2>
					</section>

					<section>
						<h2>Moi</h2>

						Administrateur systèmes et réseaux<br />
						Développeur PHP <span class="fragment">5</span><span class="fragment emphasizing">.4</span>
					</section>

					<section data-background-image="./images/backgrounds/hand-finger-indicate-the-wood-158769.jpeg" data-background-size="contain">
						<h2>Vous ?</h2>
					</section>
				</section>

				<section>
					<section class="section-title" data-title="HTTP, TLS/SSL, confiance">
						<h2>HTTP+SSL et la confiance</h2>
					</section>

					<section>
						<h2><em>HTTPS</em> = <em>HTTP</em> + <em>SSL</em>/<em>TLS</em></h2>

						<p>
							<em>SSL</em>&nbsp;: <em>Secure Sockets Layer</em><br />
							<em>TLS</em>&nbsp;: <em>Transport Layer Security</em><br />
							(sur-)couches de sécurisation<br />
						</p>
						<p class="fragment">
							<em>TLS</em> v1 &asymp; <em>SSL</em> v4<br />
						</p>
						<p class="fragment">
							Permet l'authentification (réciproque au besoin)<br />
							La confidentialité et l'intégrité des données.<br />
						</p>
					</section>

					<section>
						<h2><em>TLS</em> en action</h2>

						<ol>
							<li>C: initie la connexion <em>TLS</em></li>
							<li>S: répond avec son certificat</li>
							<li>C: essaie de déchiffrer le certificat et le valide</li>
							<li>C: génère une clé de session et l'envoie (chiffrée)</li>
							<li>S et C chiffreront leur échanges avec cette clé</li>
						</ol>
						
					</section>
				</section>

				<section>
					<section class="section-title" data-title="Pourquoi HTTPS ?">
						<h2>Pourquoi vouloir de l'HTTPS ?</h2>
					</section>

					<section>
						<ul>
							<li>Ne pas se restreindre (accès de partout)</li>
							<li>Respecter l'utilisateur</li>
						</ul>
					</section>

					<section>
						<h2>Incitations</h2>

						<p>Les autres</p>

						<div class="fragment">
							Et les navigateurs&nbsp;<br />
							<img data-src="./images/browser-password_over_http.png" alt="Aperçu d'un champ de mot de passe en HTTP:// dans Chromium" />
						</div>
					</section>

					<section>
						<h2>Sans pitié</h2>

						<div><img data-src="./images/browser_bar-invalid_certificate.png" alt="Aperçu d'un accès HTTPS:// avec certificat invalide dans Chromium" /></div>

						<div class="fragment"><img data-src="./images/flame-1964066.svg" style="height: 5em; vertical-align: bottom;" alt="Flamme de feu" /></div>
					</section>
				</section>

				<section>
					<section class="section-title" data-title="Les ACs">
						<h2>Les <span class="emphasizing">A</span>utorités de <span class="emphasizing">C</span>ertification (<em>AC</em>)</h2>
					</section>

					<section>
						<blockquote>Une autorité de certification est un <strong class="fragment highlight-red" data-synced-fragment-group="ca-wp-quote">tiers de confiance</strong> permettant d'authentifier l'identité des correspondants.</blockquote>
						<blockquote>Une autorité de certification <strong class="fragment highlight-red" data-synced-fragment-group="ca-wp-quote">délivre des certificats</strong> décrivant des identités numériques et met à disposition les moyens de <strong class="fragment highlight-red" data-synced-fragment-group="ca-wp-quote">vérifier la validité</strong> des certificats qu'elle a fourni.</blockquote>
						<em>(Source&nbsp;: <a href="https://fr.wikipedia.org/wiki/Autorit%C3%A9_de_certification" title="Article «&nbsp;Autorité de certification&nbsp;» sur Wikipédia France">Wikipédia</a>)</em>
					</section>

					<section>
						<h2>Passez au <span class="smaller">(cadenas)</span> vert...</h2>

						<ul>
							<li>
								HTTP:// en clair&nbsp;:<br />
								<img data-src="./images/browser_bar-http.png" alt="Aperçu d'un accès HTTP:// dans Chromium" />
							</li>
							<li class="fragment"><em>DV</em>, <em>Domain Validation</em> (anonyme)&nbsp;:</li>
							<li class="fragment">
								<em>OV</em>, <em>Organization Validation</em> (nommé)&nbsp;:<br />
								<img data-src="./images/browser_bar-dv,ov.png" alt="Aperçu d'un accès HTTPS:// niveau DV ou OV dans Chromium" />
							</li>
							<li class="fragment">
								<em>EV</em>, <em>Extended Validation</em> (nommé, contrôlé)&nbsp;:<br />
								<img data-src="./images/browser_bar-ev.png" alt="Aperçu d'un accès HTTPS:// niveau EV dans Chromium" />
							</li>
						</ul>
						<p class="fragment">...Avec des billets verts</p>
					</section>

					<section data-background-image="./images/backgrounds/snail-1447233_1920.jpg" data-background-size="contain" data-state="dim-background">
						<h2>Processus standard</h2>

						<ol>
							<li>(Payer)</li>
							<li>Générer une <em>CSR</em> (<em>Certificate Signing Request</em>)&nbsp;:
							<pre><code class="bash" data-trim>
							openssl req -new -out webserver.csr \
							    -key webserver.key -sha256
							</code></pre></li>
							<li>Coller la <em>CSR</em> sur l'interface de l'<em>AC</em></li>
							<li>(Prouver la propriété du domaine)</li>
							<li>
								Récupérer le contenu du certificat <br />
								et le coller sur le serveur
							</li>
						</ol>
					</section>
				</section>

				<section>
					<section class="section-title" data-title="Une PKI">
						<h2>Une infra de gestion de clés</h2>

						<p class="fragment"><em><span class="emphasizing">P</span>ublic <span class="emphasizing">K</span>ey <span class="emphasizing">I</span>nfrastructure</em> = Les logiciels de l'<em>AC</em></p>
					</section>

					<section>
						<p>Libérés</p>
						<p class="fragment">mais toujours occupés</p>
						<p class="fragment">et isolés</p>
					</section>
				</section>

				<section>
					<section class="section-title" data-title="Let's Encrypt">
						<h2><img data-src="./images/lets_encrypt-logo-lock.svg" style="height: 2em; vertical-align: bottom;" alt="Logo de Let's Encrypt" /> <em>Let's Encrypt</em></h2>

						<ul>
							<li>Une <em>AC</em></li>
							<li>Sortie de beta en avril 2016</li>
							<li>Certificats <em>DV</em> gratuits de 90 jours</li>
							<li>Reconnue par les navigateurs</li>
							<li>Simple d'utilisation grâce à <em>ACME</em></li>
						</ul>
					</section>

					<section>
						<h2><em><span class="emphasizing">A</span>utomatic <span class="emphasizing">C</span>ertificate <span class="emphasizing">M</span>anagement <span class="emphasizing">E</span>nvironment</em></h2>

						<p>
							Framework client/serveur<br />
							API REST<br />
							Prévu pour des domaines<br />
							1 compte client = une paire de clés publique/privée<br />
						</p>
					</section>

					<section>
						<h2>
							Théorie d'<em>ACME</em><br />
							<span class="smaller">(demande de certificat)</span>
						</h2>

						<ol>
							<li>Client génère une CSR</li>
							<li>Serveur propose différents <em>challenges</em></li>
							<li>Client en relève un et informe le serveur</li>
							<li>Serveur vérifie</li>
							<li>Client télécharge certificat</li>
						</ol>
					</section>

					<section>
						<h2>Différentes validations (<em>DV</em>)</h2>
						<ul>
							<li>
								HTTP (<em>http-01</em>)&nbsp;: Fichier<br />
								<span class="smaller"><code>http://<span class="variable">{domain}</span>/.well-known/acme-challenge/<span class="variable">{token}</span></code></span>
							</li>
							<li>
								DNS (<em>dns-01</em>)&nbsp;: Enregistrement <code>TXT</code><br />
								<span class="smaller"><code>_acme-challenge.<span class="variable">{domain}</span>. 300 IN TXT "<span class="variable">{hash-auth-key}</span>"</code></span>
							</li>
							<li>
								TLS + SNI (<em>tls-sni-02</em>)&nbsp;: Certificat auto-signé<br />
								<span class="smaller">SAN 1 = <code><span class="variable">{hash-token}</span>.token.acme.invalid</code></span><br />
								<span class="smaller">SAN 2 = <code><span class="variable">{hash-auth-key}</span>.ka.acme.invalid</code></span>
							</li>
							<li>
								Manuelle (<em>oob-01</em>)&nbsp;: À faire à la main<br />
								<span class="smaller">Pour les cas particuliers</span>
							</li>
						</ul>
					</section>

					<section>
						<h2>Processus idéal</h2>

						<p>Avec un serveur web compatible <em>ACME</em>&nbsp;:</p>

						<ol>
							<li>Saisie du nom de domaine</li>
							<li>Choix d'une <em>AC</em></li>
							<li>(Paiement)</li>
						</ol>
						
						<p class="fragment">
							Le serveur web génère la clé, la <em>CSR</em>,<br />
							contacte l'<em>AC</em>, récupère le certificat,<br />
							l'installe et planifie les futures MAJ.<br />
						</p>
						<p class="fragment"><em>Profit!</em></p>
					</section>

					<section>
						<h2><img data-src="./images/caddy-logo_blue.svg" alt="Logo de Caddy" /></h2>

						Intègre un client <em>ACME</em><br />
						<em>On-Demand TLS</em><br />
						Support des challenges <em>HTTP</em>, <em>TLS-SNI</em> et <em>DNS</em><br />
						<ul>
							<li><em>Cloudflare</em></li>
							<li><em>DigitalOcean</em></li>
							<li><em>AWS Route 53</em>, <em>Dyn</em>, <em>Google Cloud DNS</em></li>
							<li><em>Gandi</em>, <em>OVH</em></li>
							<li><em>RFC2136</em> (<em>DNS UPDATE</em>)</li>
						</ul>
					</section>

					<section>
						<h2>Autres implémentations notables</h2>

						<ul>
							<li><code>amphp/aerys</code></li>
							<li><em>Mesosphere DCOS</em></li>
							<li>Des <em>Control Panel</em></li>
							<li>Des solutions d'auto-hébergement (e-mails, fichiers, etc.)</li>
						</ul>
					</section>

					<section data-background-image="./images/backgrounds/code-1486361_1920.jpg" data-background-size="contain" data-state="dim-background">
						<h2>Les commandes</h2>

						<p>Installation (Debian)</p>
						<pre><code class="bash" data-trim>
						aptitude install certbot
						</code></pre>

						<div class="fragment">
							<p>Demande de certificat (validation par <em>http-01</em>)</p>
							<pre class="fragment"><code class="bash" data-trim>
							certbot certonly --standalone -d "foo.example.com,bar.example.com"
							</code></pre>

							<pre class="fragment"><code class="bash" data-trim>
							certbot certonly --webroot \
							    -w /var/lib/letsencrypt/webroot/ \
							    -d "foo.example.com" \
							    -d "bar.example.com"
							</code></pre>
						</div>
					</section>

					<section data-background-image="./images/backgrounds/code-1486361_1920.jpg" data-background-size="contain" data-state="dim-background">
						<h2>Configs serveur pour <code>webroot</code></h2>

						<pre data-language="apache"><code data-trim>
						Alias                           "/.well-known/acme-challenge/" \
						    "/var/lib/letsencrypt/webroot/.well-known/acme-challenge/"
						&lt;Directory "/var/lib/letsencrypt/webroot"&gt;
						    Options None
						    AllowOverride None
						    ForceType text/plain
						    Require all granted
						    RedirectMatch 404 "^(?!/\.well-known/acme-challenge/[\w-]{43}$)"
						&lt;/Directory&gt;
						</code></pre>

						<pre data-language="nginx"><code data-trim>
						location ^~ /.well-known/acme-challenge/ {
						    allow all;
						    default_type "text/plain";
						    root /var/lib/letsencrypt/webroot;
						}
						location = /.well-known/acme-challenge/ {
						    return 404;
						}
						</code></pre>
					</section>

					<section>
						<p>L'<em>AC</em> <em>Let's Encrypt</em> demande deux choses&nbsp;:<br />
						<img data-src="./images/certbot-email.png" alt="E-mail de contact pour Let's Encrypt" />
						<img data-src="./images/certbot-terms.png" alt="Acceptation des conditions de Let's Encrypt" /></p>

						<pre><code class="text" data-trim>
						Saving debug log to /var/log/letsencrypt/letsencrypt.log
						Enter email address (used for urgent renewal and security notices)
						(Enter 'c' to cancel):foo@example.com
						Starting new HTTPS connection (1): acme-v01.api.letsencrypt.org

						----------------------------------------------------------------------
						Please read the Terms of Service at
						https://letsencrypt.org/documents/LE-SA-v1.1.1-August-1-2016.pdf. You 
						must agree in order to register with the ACME server at
						https://acme-v01.api.letsencrypt.org/directory
						----------------------------------------------------------------------
						(A)gree/(C)ancel: A
						</code></pre>

						<p class="fragment"><code>certbot</code> crée clés et certificats dans <code>/etc/letsencrypt/live/foo.example.com/</code></p>
					</section>

					<section>
						<h2>Validation DNS manuelle</h2>

						<pre><code class="bash" data-trim>
						certbot certonly --manual --preferred-challenges dns -d "example.com"
						</code></pre>

						<div class="fragment">
							<pre style="margin-bottom: 0px;"><code class="text" data-trim>
							Obtaining a new certificate
							Performing the following challenges:
							</code></pre>

							<pre class="emphasizing" style="margin-top: 0px; margin-bottom: 0px;"><code class="text" data-trim>
							dns-01 challenge for example.com
							</code></pre>

							<pre style="margin-top: 0px; margin-bottom: 0px;"><code class="text" data-trim>
							NOTE: The IP of this machine will be publicly [...]
							Are you OK with your IP being logged?
							(Y)es/(N)o: Y
							Please deploy a DNS TXT record under the name
							_acme-challenge.example.com with the following value:
							</code></pre>

							<pre class="emphasizing" style="margin-top: 0px; margin-bottom: 0px;"><code class="text" data-trim>

							D4pmHUsxThdsyGvcWy0w-BC9tiPk34ZBpqs5EQMf0CSkB

							</code></pre>

							<pre style="margin-top: 0px; margin-bottom: 0px;"><code class="text" data-trim>
							Once this is deployed,
							</code></pre>

							<pre class="emphasizing" style="margin-top: 0px; margin-bottom: 0px;"><code class="text" data-trim>
							Press Enter to Continue
							</code></pre>

							<pre style="margin-top: 0px;"><code class="text" data-trim>
							Waiting for verification...
							Cleaning up challenges
							Generating key (2048 bits): /etc/letsencrypt/keys/0001_key-certbot.pem
							Creating CSR: /etc/letsencrypt/csr/0001_csr-certbot.pem
							</code></pre>
						</div>
					</section>

					<section>
						<h2>Validation DNS auto (OVH)</h2>

						<p>Avec le client <code>Neilpang/acme.sh</code></p>
						
						<div class="fragment">
							Préparation&nbsp;:<br />
							<pre><code class="bash" data-trim>
							export OVH_AK="OVH_application_key"
							export OVH_AS="OVH_application_secret"
							acme.sh --issue -d foo.example.com --dns dns_ovh
							# Ouvrir l'URL d'autorisation d'API OVH et autoriser le client
							</code></pre>
						</div>

						<div class="fragment">
							Réelle demande de certificat&nbsp;:<br />
							<pre><code class="bash" data-trim>
							acme.sh --issue -d foo.example.com --dns dns_ovh
							</code></pre>
						</div>
						
						<p class="fragment">Gère&nbsp;: <em>Alwaysdata</em>, <em>Cloudflare</em>, <em>GoDaddy</em>, <em>AWS Route 53</em>, <em>DigitalOcean</em>, ...</p>
					</section>

					<section data-background-image="./images/backgrounds/code-1486361_1920.jpg" data-background-size="contain" data-state="dim-background">
						<h2>Renouvellement</h2>

						Renouvellement en une commande&nbsp;:<br />
						<pre><code class="bash" data-trim>
						/usr/bin/certbot renew
						</code></pre>
						
						<div class="fragment">
							Automatisé c'est mieux&nbsp;:<br />
							<pre><code class="bash" data-trim>
							# Renew + reload serveur
							cmd="/usr/bin/certbot \
							         renew \
							         --quiet --no-self-upgrade \
							         --renew-hook \"/usr/sbin/service nginx reload\""

							# Planification entre 2h et 3h
							echo "\
							    $(expr $(od -An -N1 -i /dev/urandom)\%60 | tr -d ' ') 2 * * * \
							    root $cmd" \
							    > /etc/cron.d/certbot
							</code></pre>
					</section>

					<section>
						<h2>Ils soutiennent <em>Let's Encrypt</em></h2>

						<ul>
							<li>Mozilla</li>
							<li>Akamai</li>
							<li>Cisco</li>
							<li>EFF</li>
							<li>OVH</li>
							<li>Chrome</li>
							<li>Gemalto</li>
							<li>Facebook</li>
							<li>Gandi </li>
							<li>Automattic</li>
						</ul>
					</section>
				</section>

				<section>
					<section>
						<h2>Conclusion</h2>

						<p>Pour nous...</p>

						<ul>
							<li>D'abord plus de sécurité</li>
							<li>Puis ouverture à moindre coût</li>
						</ul>

						<div class="fragment">
							<p><em>Let's Encrypt</em> c'est ...</p>

							<ul>
								<li>Gratuit</li>
								<li>Simple (<em>fire and forget</em>)</li>
								<li>
									Utilisé par beaucoup<br />
									(10 millions de certificats en sept. 2016)<br />
									<span class="fragment">(et 10 millions supplémentaires, deux mois plus tard)<br />
								</li>
								<li class="fragment">...nous rapproche tous d'un web 100% chiffré</li>
							</ul>
						</div>
					</section>
				</section>

				<section>
					<section>
						<h2>Questions ?</h2>
					</section>
				</section>

				<section>
					<h2>Merci</h2>

					<p><span class="fragment">à vous</span><span class="fragment">, et à l'AFUP Lyon</span></p>

					<div class="fragment">
						<p>Pour poursuivre la découverte et vos questions ultérieures&nbsp;:</p>
						<ul style="list-style-type: none;">
							<li><img data-src="./images/pictos/home.png" />&nbsp; <a href="https://blog.claude.duvergier.fr">http<span class="fragment highlight-red">s</span>://blog.claude.duvergier.fr</a><br /></li>
							<li><img data-src="./images/pictos/github.png" />&nbsp; <a href="https://github.com/C-Duv/">C-Duv</a><br /></li>
							<li><img data-src="./images/pictos/twitter.png" />&nbsp; <a href="https://twitter.com/C_Duv">@C_Duv</a></li>
						</ul>
					</div>
				</section>
			</div>
		<footer>
			<div class="title" />
		</footer>
		</div>

		<!--
		Source des images :
		https://www.pexels.com/photo/left-index-finger-158769/
		https://www.pexels.com/photo/dirt-road-path-wayside-nature-30725/
		https://pixabay.com/fr/silhouettes-de-l-homme-groupe-68483/
		https://pixabay.com/en/snail-obstacle-overcoming-will-1447233/
		https://pixabay.com/en/code-programming-computer-data-1486361/
		https://pixabay.com/fr/la-flamme-le-feu-vector-logo-1964066/
		-->

		<script src="lib/js/head.min.js"></script>
		<script src="js/reveal.js"></script>
		<script src="lib/js/jquery.min.js"></script>

		<script>
			// More info https://github.com/hakimel/reveal.js#configuration
			Reveal.initialize({
				/* Dev:
				controls: true,
				slideNumber: true,
				showNotes: true,
				//*/

				//* Prod:
				controls: false,
				slideNumber: false,
				showNotes: false,
				//*/

				history: true,
				width: 1024,
				height: 768,

				transition: 'none', // none/fade/slide/convex/concave/zoom

				// More info https://github.com/hakimel/reveal.js#dependencies
				dependencies: [
					{ src: 'plugin/notes/notes.js', async: true },
					{ src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
				]
			});

			// MAJ du footer : Nom de partie dans le footer
			updateFooter = function (event) {
				var firstSectionSlide = $(event.currentSlide).parent("section").children("section:first.section-title")
				if (firstSectionSlide.data('title')) {
					$('body footer > div.title').text(firstSectionSlide.data('title'));
					$('body footer > div.title').show();
				}
				else {
					$('body footer > div.title').hide();
				}
			}
			Reveal.addEventListener('ready', updateFooter);
			Reveal.addEventListener('slidechanged', updateFooter);

			// Synced fragment groups
			Reveal.addEventListener( 'fragmentshown', function( event ) {
				if (groupIdentifier = $(event.fragment).data('synced-fragment-group')) {
					// Show other group members
					var fragments = $(Reveal.getCurrentSlide()).find(".fragment[data-synced-fragment-group='" + groupIdentifier + "']:not(.current-fragment)");
					$(fragments).addClass('visible');
				}
			} );
			Reveal.addEventListener( 'fragmenthidden', function( event ) {
				if (groupIdentifier = $(event.fragment).data('synced-fragment-group')) {
					// Hide other group members
					var fragments = $(Reveal.getCurrentSlide()).find(".fragment[data-synced-fragment-group='" + groupIdentifier + "']");
					$(fragments).removeClass('visible');
				}
			} );
		</script>
	</body>
</html>
